@extends('layouts.app')

@section('styles')
    
@endsection

@section('content')
    <div class="row">
        <div class="col-md-12">
            @php
            $isDisabled = session('user_id') != $header->user_id ? 'disabled' : '';
            @endphp
@php
    $readonly = session('user_id') != $header->user_id ? 'readonly' : '';
    $disabled = session('user_id') != $header->user_id ? 'disabled' : '';
    $isOwner = session('user_id') == $header->user_id;
@endphp

<div class="card">
    <form id="request-form" action="{{ route('update.request', ['id' => $header->id]) }}" method="POST">
        @csrf
        <div class="card-body">
            <div class="row" style="text-align:center">
                <h5>Edit Vehicle Request</h5>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-8 mb-2">
                    <div class="form-group">
                        <div class="form-label">Purpose: </div>
                        <textarea class="form-control form-input" name="purpose" {{ $readonly }}>{{ $header->purpose }}</textarea>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <div class="form-label">Vehicle Type: </div>
                        <select class="form-select form-select-lg form-input" name="requested_vehicle" aria-label="Large select example" style="font-size: 13px;" {{ $disabled }}>
                            <option value="" {{ old('requested_vehicle') ? '' : 'selected' }}> Select a vehicle</option>
                            @foreach($vehicle_types as $type)
                                <option value="{{ $type }}" {{ $header->requested_vehicle == $type ? 'selected' : '' }}>{{ $type }}</option>
                            @endforeach
                        </select>
                        @if(!$isOwner)
                            <input type="hidden" name="requested_vehicle" value="{{ $header->requested_vehicle }}">
                        @endif
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <table class="table" style="display:block; overflow-x:auto;">
                        <thead>
                            <th>Time of Departure</th>
                            <th>Requested Hrs</th>
                            <th>Starting Location</th>
                            <th>Destination</th>
                            <th>Trip Type</th>
                            <th>Name of Passenger(s)</th>
                            <th></th>
                        </thead>
                        <tbody id="table-body">
                            @for($i = 0; $i < count($details); $i++)
                                <tr class="data-row" data-row-id="{{ $i }}">
                                    <input type="hidden" name="id[]" value="{{ $details[$i]->id ?? '' }}"/>
                                    <td>
                                        <input type="datetime-local" class="form-control" name="datetime[]" value="{{ $details[$i]->departure_time }}" style="width:100%; font-size:13px;" {{ $readonly }}/>
                                    </td>
                                    <td>
                                        <input type="number" class="form-control" name="requested_hrs[]" value="{{ $details[$i]->requested_hrs }}" style="width:100%; font-size:13px;" {{ $readonly }}/>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control" name="destination_from[]" value="{{ $details[$i]->destination_from }}" style="width:100%; font-size:13px;" {{ $readonly }}/>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control" name="destination_to[]" value="{{ $details[$i]->destination_to }}" style="width:100%; font-size:13px;" {{ $readonly }}/>
                                    </td>
                                    <td>
                                        <select class="form-select form-input trip-select" name="trip_type[]" style="font-size: 13px;" {{ $readonly }}>
                                            <option value="{{ $details[$i]->trip_type }}" >{{ $details[$i]->trip_type }}</option>
                                        </select>
                                    </td>
                                    <td>
                                        <select class="form-control emp-select1 {{ !$isOwner ? 'readonly-select2' : '' }}" id="passengers-{{ $i }}" name="passengers[{{ $i }}][]" multiple true  style="width: 100%" {{ $readonly }}>
                                        @foreach($select_passengers as $passenger)
                                        <option value="{{ $passenger->EmpID }}|{{ $passenger->FullName }}">{{$passenger->FullName}}</option>
                                            @endforeach
                                        </select>
                                    </td>
                                    <td>
                                            <button class="btn btn-danger" type="button" onclick="removeRow({{ $i }})"><i class="fa-solid fa-circle-minus" style="color:white"></i></button>

                                    </td>
                                </tr>
                            @endfor
                          
                                <tr id="add-btn-row">
                                    <td colspan="7" style="text-align: center">
                                        <button class="btn btn-primary" id="add-btn" type="button">
                                            <i class="fa-solid fa-circle-plus"></i> Add more
                                        </button>
                                    </td>
                                </tr>

                        </tbody>
                    </table>
                </div>
            </div>

            <p style="font-size: 0.7rem;">Note: Submit the requisition (2) two days before the scheduled trip and must notify (1) one day before to requesting department if approve or reject.</p>

            <div style="display:flex; flex-direction:row; justify-content:end;">

                    <button class="btn btn-primary me-2 d-flex flex-row align-items-center" id="update-btn" type="submit">
                        <i class="fa-solid fa-paper-plane"></i> 
                        &nbsp;
                        <p id="submit-btn-text">Update</p>
                    </button>

                <button class="btn btn-danger" type="button" onclick="returnToDash()">
                    <i class="fa-solid fa-circle-xmark"></i> Cancel
                </button>
            </div>
        </div>
    </form>
</div>


        </div>
    </div>

    <script>
        $(document).ready(function() {
            // $('.emp-select2').select2({
            //     ajax:{
            //         url: "http://vbs.test/api/hris-api.php",
            //         delay: 2000,
            //         data: function (params) {
            //             var query = {
            //                 emp: params.term
            //             }
                        
            //             return query;
            //         },
            //         processResults: function (data) {
            //             data = JSON.parse(data);
            //             let processedArray = [];

            //             for(index = 0; index < data.length; index++) {
            //                 let currentIndex = data[index];
            //                 let passengerData = `${currentIndex.EmpID}|${currentIndex.FullName}`;

            //                 processedArray.push({id: passengerData, text:currentIndex.FullName});
            //             }

            //             return {
            //                 results: processedArray 
            //             }
            //         }
            //     }
            // });

            setSelect2Inputs();

            // Set passengers' data for Select2 input
            let passengersData = JSON.parse('{!! json_encode($passengers) !!}');

            let initialPassengers = []; // Array of passengers' Maps per RequestDetail
            passengersData.forEach(function (currentValue, selectIndex){ 
                let splitPassengers = currentValue.split('/');

                let row = [];
                splitPassengers.forEach(function (currentPassenger, passengerIndex){
                    let rowPassengersData = new Map();
                    let singlePassengerData = currentPassenger.split('|');

                    let newOption = new Option(singlePassengerData[1], currentPassenger, false, true);
                    $(`#passengers-${selectIndex}`).append(newOption).trigger('change');

                    rowPassengersData.set("id", singlePassengerData[0]);
                    rowPassengersData.set("text", singlePassengerData[1]);

                    row.push(rowPassengersData);
                });
                
                initialPassengers.push(row);
            });
        });
        
        // let count = 2; // For rowId
        let rowCount = $('#table-body').find('tr').length - 1;
        document.addEventListener('DOMContentLoaded', (event) => {
            const reqForm = document.getElementById('request-form');
            const addBtn = document.getElementById('add-btn');
            const updateBtn = document.getElementById('update-btn');
            const tableBody = $('#table-body');
            const passengerList = @json($select_passengers);
        let passengerOptions = '';
        passengerList.forEach(p => {
        passengerOptions += `<option value="${p.EmpID}|${p.FullName}">${p.FullName}</option>`;
            } );
            
            // const removeBtn = dosucment.getElementById('remove-btn');

            let count = rowCount + 1;

            if (rowCount == 5) {
                $('#add-btn-row').hide();
            }

            addBtn.addEventListener('click', function(event) {
    var lastRow = document.querySelectorAll('.data-row');
    var lastRowDate = '', lastHours = '', lastFrom = '', lastTo = '', lastTripType = '';
    
    if (lastRow.length > 0) {
        let last = lastRow[lastRow.length - 1];
        lastRowDate = last.querySelector('input[name="datetime[]"]')?.value || '';
        lastHours = last.querySelector('input[name="requested_hrs[]"]')?.value || '';
        lastFrom = last.querySelector('input[name="destination_from[]"]')?.value || '';
        lastTo = last.querySelector('input[name="destination_to[]"]')?.value || '';
        lastTripType = last.querySelector('select[name="trip_type[]"]')?.value || '';
    }

    var newRow = document.createElement('tr');
    var rowID = getNewRowID(rowCount);
    newRow.classList.add('data-row');
    newRow.setAttribute('data-row-id', rowID);
    

    newRow.innerHTML = `
        <input type="hidden" name="id[]" value=""/>
        <td>
            <input type="hidden" name="row_id" value="${rowCount}"/>
            <input type="datetime-local" step="3600" class="form-control form-input" name="datetime[]" value="${lastRowDate}" readonly style="width:100%; font-size:13px;" required/>
        </td>
        <td>
            <input type="number" class="form-control form-input" name="requested_hrs[]" value="${lastHours}" readonly style="width:100%; font-size:13px;" min="1" required/>
        </td>
        <td>
            <input type="text" class="form-control form-input" name="destination_from[]" value="${lastFrom}" readonly style="width:100%; font-size:13px;" required/>
        </td>
        <td>
            <input type="text" class="form-control form-input" name="destination_to[]" value="${lastTo}" readonly style="width:100%; font-size:13px;" required/>
        </td>
        <td>
            <select class="form-select " name="trip_type[]" style="font-size: 13px;" {{ $readonly }}>
                <option value="${lastTripType}" >${lastTripType}</option>
            </select>    
        </td>
        <td>
        
           <select class="form-control emp-select2" id="passengers-${rowID}" name="passengers[${rowID}][]" multiple="multiple" style="width: 100%">
                    ${passengerOptions}
                </select>
</td>
        <td>
            <button class="btn btn-danger" type="button" onclick="removeRow(${rowID})"><i class="fa-solid fa-circle-minus" style="color:white"></i></button>
        </td>
    `;

    $(newRow).insertBefore($('#add-btn-row'));
    rowCount++;

    if (rowCount > 4) {
        $('#add-btn-row').hide();
    }

    setSelect2Inputs(rowCount); // Re-init select2 for new dropdown
    $(`#passengers-${rowID}`).select2({
    placeholder: 'Select passenger(s)',
    allowClear: true
});
});


            updateBtn.addEventListener('click', function(event){
                $('#submit-btn').prop('disabled', true);
                $('#submit-btn-text').text('Updating...');

                tableBody.children()
                    .not('#add-btn-row')
                    .each(function(index, element) {
                        
                        // Check if the row has values to make it 'required' to serialized form
                        var isRowChanged = false;
                        $(this).children()
                            // .not('#trip-type-col')
                            .not('#remove-btn-col')
                            .each(function(innerIndex, rowElement) {
                                let inputElement = $(this).find('input').first().val();
                                if(inputElement != '' && inputElement != undefined) {
                                    isRowChanged = true;
                                }
                                
                                let selectElement = $(rowElement).children(':first-child');
                                let selectValues = selectElement.val();
                                if (selectElement.not('.trip-select').is('select') && (selectValues.length == 0 || selectValues[selectValues.length - 1] == undefined)) {
                                    
                                    // console.log('row: ' + index + ' passengers is either empty or null');
                                    // console.log('value: ' + selectElement.val() + '| has value: ' + (selectElement.val().length != 0) +'|' + selectElement.val().length);
                                    // console.log('last element is undefined: ' + (selectElement.val()[selectElement.val().length - 1] == undefined) + '|' + selectElement.val()[selectElement.val().length - 1]);
                                    
                                    var nullOption = new Option('NULL', 'null', false, false);
                                    selectElement.append(nullOption).trigger('change');

                                    selectElement.val('null').trigger('change');
                                    // alert(selectElement.val());
                                }
                            });
                        
                        if(isRowChanged) {
                            $(this).children()
                                // .not('#trip-type-col')
                                .not('#remove-btn-col')
                                .each(function(innerIndex, element) {
                                    $(this).find('input, select').first().prop('required', false);
                                });
                        }
                    });

                // Serialize the form
                let requestData = new FormData($('#request-form').get(0));

                // Clear 'NULL' passenger inputs after serializing request form data
                tableBody.children()
                    .not('#add-btn-row')
                    .each(function(index, row) {
                        let rowSelect2 = $(row).children().find('.emp-select2'); 
                        let rowSelect2Length = rowSelect2.val().length; 
                        if(rowSelect2Length != 0 && (rowSelect2.val()[rowSelect2Length - 1] == 'null' || rowSelect2.val()[rowSelect2Length - 1] == undefined)) { 
                            rowSelect2.val(null).trigger('change');
                        } else {
                            // console.log('NOT EMPTY INDEX: ' + index);
                        }
                    });

                // AJAX POST request setup
                $.ajaxSetup({
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content') 
                    }
                });

                $.ajax({
                    url: '/request/update/{{ $header->id }}',
                    method : 'POST',
                    data: requestData,
                    processData: false,
                    contentType: false,
                    success: function(response){
                        const protocol = window.location.protocol;
                        const hostname = window.location.hostname;
                        const port = (window.location.port && window.location.port !== undefined) ? `${window.location.port}` : '';

                        if(response.status != 'error') {
                            // console.log(response);
                            // console.log('response.data');
                            window.location.href = `${protocol}//${hostname}:${port}`; // Dashboard
                            triggerToast(response.status, response.message);
                        } else {
                            // console.log('error');
                            // console.log('error at: ' + response.validation + '|' + response.input + '|' + response.row);

                            if(response.validation == 'initial') { 
                                let reqFormElement = $('#request-form');
                                let listenerType = response.input == 'purpose' ? 'keydown' : 'change';
                                
                                reqFormElement.find(`[name="${response.input}"]`).css({
                                    'border-color': '#f1aeb5',
                                    'background-color': '#f8d7da'
                                });

                                reqFormElement.on(listenerType, `[name="${response.input}"]`, function() {
                                    $(this).css({
                                        'border-color': '#dee2e6',
                                        'background-color': '#ffffff'
                                    })
                                });
                            } else if (response.validation == 'latter') {
                                let failedRows = response.row;
                                let failedInputs = response.input;

                                
                                failedRows.forEach(function(element, failedIndex) {
                                    // console.log(failedIndex);
                                    // console.log(failedRows[failedIndex] + ' | ' + failedInputs[failedIndex]);

                                    tableBody.children()
                                        .not('#add-btn-row')
                                        .each(function(index, row) {
                                            if(index == failedRows[failedIndex]) {
                                                if(failedInputs[failedIndex] == 'passengers') {
                                                    let selectInput = $(row).find(`[name="${failedInputs[failedIndex]}[${failedRows[failedIndex]}][]"]`);
                                                    let spanSelect = selectInput.siblings().find('.select2-selection--multiple');

                                                    spanSelect.addClass('form-input');
                                                    spanSelect.css({
                                                        'border-color': '#f1aeb5',
                                                        'background-color': '#f8d7da'
                                                    });
                                                    
                                                    selectInput.on('select2:select', function() {
                                                        spanSelect.css({
                                                            'border-color': '#dee2e6',
                                                            'background-color': '#ffffff'
                                                        });
                                                    });
                                                } else {
                                                    let listenerType = failedInputs[failedIndex] == 'trip_type' ? 'change' : 'keydown';

                                                    $(row).find(`[name="${failedInputs[failedIndex]}[]"]`).css({
                                                        'border-color': '#f1aeb5',
                                                        'background-color': '#f8d7da'
                                                    });
                                                    
                                                    $(row).on(listenerType, `[name="${failedInputs[failedIndex]}[]"]`, function() {
                                                        $(this).css({
                                                            'border-color': '#dee2e6',
                                                            'background-color': '#ffffff'
                                                        });
                                                    });
                                                }
                                            }
                                        });
                                    });
                                // tableBody.children()
                                //     .not('#add-btn-row')
                                //     .each(function(index, row) {
                                //         if(index == response.row) {
                                //             if(response.input == 'passengers') {
                                //                 let selectInput = $(row).find(`[name="${response.input}[${response.row}][]"]`);
                                //                 let spanSelect = selectInput.siblings().find('.select2-selection--multiple');
                                //                 spanSelect.addClass('form-input');
                                //                 spanSelect.css({
                                //                     'border-color': '#f1aeb5',
                                //                     'background-color': '#f8d7da'
                                //                 });
                                                
                                //                 selectInput.on('select2:select', function() {
                                //                     spanSelect.css({
                                //                         'border-color': '#dee2e6',
                                //                         'background-color': '#ffffff'
                                //                     });
                                //                 });
                                //             } else {
                                //                 $(row).find(`[name="${response.input}[]"]`).css({
                                //                     'border-color': '#f1aeb5',
                                //                     'background-color': '#f8d7da'
                                //                 });
                                                
                                //                 $(row).on('keydown', `[name="${response.input}[]"]`, function() {
                                //                     $(this).css({
                                //                         'border-color': '#dee2e6',
                                //                         'background-color': '#ffffff'
                                //                     });
                                //                 });
                                //             }
                                //         }
                                //     });
                            }
                            
                            let errorMessage = response.input.length == 1 ? response.message : 'Multiple errors found. Errors are highlighted in the form.'; 
                            console.log(response.input + '|' + response.input.length);
                            triggerToast(response.status, errorMessage);
                        }      
                    },
                    error: function(data) {
                        // console.log('ajax error');
                        // console.log(data);
                        triggerToast('error', data.responseText);
                    }
                });

                $('#submit-btn').prop('disabled', false);
                $('#submit-btn-text').text('Update');
            });
        });

        // OLD FUNCTION FETCH EMPLYOEE  function setSelect2Inputs () {
        //     const protocol = window.location.protocol;
        //     const hostname = window.location.hostname;
        //     const port = window.location.port ? `:${window.location.port}` : '';
        //     $('.emp-select2').select2({
        //         ajax:{
        //             url: `${protocol}//${hostname}${port}/api/hris-api.php`,
        //             delay: 2000,
        //             data: function (params) {
        //                 var query = {
        //                     emp: params.term
        //                 }

        //                 return query;
        //             },
        //             processResults: function (data) {
        //                 data = JSON.parse(data);
        //                 let processedArray = [];

        //                 for(index = 0; index < data.length; index++) {
        //                     let currentIndex = data[index];
        //                     let passengerData = `${currentIndex.EmpID}|${currentIndex.FullName}`;

        //                     processedArray.push({id: passengerData, text:currentIndex.FullName});
        //                 }

        //                 return {
        //                     results: processedArray 
        //                 }
        //             }
        //         }
        //     });
        // } 


    function setSelect2Inputs () {
    const protocol = window.location.protocol;
    const hostname = window.location.hostname;
    const port = window.location.port ? `:${window.location.port}` : '';

    $('.emp-select2').select2({
        allowClear: true,
        minimumInputLength: 2,
        ajax: {
            url: `${protocol}//${hostname}${port}/api/hris-api.php`,
            delay: 2000,
            dataType: 'json',
            data: (params) => ({
                emp: params.term
            }),
            processResults: (data) => {
                const results = data.map(emp => ({
                    id: `${emp.EmpID}|${emp.FullName}`,
                    text: emp.FullName
                }));
                return { results };
            }
        }
    });
}

        function getNewRowID(count) {
            const values = $('[data-row-id]').map(function (){
                return Number($(this).data('row-id'));
            }).get();

            values.sort((a, b) => a - b);
            
            for (let num = values[0]; num < values.length; num++) {
                if (num != values[num]) {
                    // console.log(num);
                    return num;
                }
            }

            return count;
        }

        function removeRow(rowId) {
            var row = document.querySelector('[data-row-id="'+ rowId +'"]');
            row.remove();
            rowCount--;

            // let rowsCount = $('#table-body').children('.data-row').length;
            // if (rowsCount < 5) {

            // }
            // // Check the remaining row's id and set it to 3 
            // $rowToChange = $('[data-row-id]');
            // if ($rowToChange.attr('data-row-id') == 4) {
            //     $rowToChange.attr('data-row-id', 3);
            // }

            if (rowId < 5) {
                $('#add-btn-row').show();
            }
        }

        function returnToDash() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const port = window.location.port ? `:${window.location.port}` : '';
            window.location.href = `${protocol}//${hostname}${port}`;
        }
    </script>
  
  <script>
document.addEventListener('DOMContentLoaded', function () {
    // Initial select2 for existing elements
    $('.emp-select1').select2({
        placeholder: 'Select',
        allowClear: true
    });

    // Optional: define reusable function
    window.initEmpSelect1 = function(selector) {
        $(selector).select2({
            placeholder: 'Select',
            allowClear: true
        });
    };
});
</script>

<script>
    $(document).ready(function () {
    $('.emp-select1').select2({
        placeholder: 'Select',
        allowClear: true
    });

    // Prevent interaction on read-only select2
    $('.readonly-select2').on('select2:opening select2:selecting select2:unselecting select2:clearing', function (e) {
        e.preventDefault();
    });

    // Disable pointer events on the visible UI
    $('.readonly-select2').each(function () {
        $(this).next('.select2-container').find('.select2-selection').css('pointer-events', 'none');
    });

    // Optional: disable keyboard events too
    $('.readonly-select2').on('keydown', function (e) {
        e.preventDefault();
    });
});

    </script>
      
@endsection
